#!/bin/bash

# Import photos from photo camera or iphone

createdatedir() {
    [[ ! -d $1 ]] && mkdir -p "$1"
}

getdatearray() {
    if [[ -n $(xdg-mime query filetype "$1" | grep -E "^(video/|application/octet-stream)") ]]; then
        # Assume it's a movie
        if [[ -n $2 && $2 == "foonjappie" ]]; then
            echo $(mediainfo "$1" | awk '/Encoded date/{print $5}' | awk -F "-" '{print $1" "$2" "$3}')
        else
            echo $(mediainfo "$1" | awk '/Recorded date/{print $4}' | awk -F "-" '{print $1" "$2" "$3}')
        fi
    elif [[ -n $(xdg-mime query filetype "$1" | grep "^image/") ]]; then
        # The file is an image
        echo $(exiv2 "$1" | awk '/Image timestamp/{print $4}' | awk -F ":" '{print $1" "$2" "$3}')
    fi
}

printdate() {
    datearray=($(getdatearray "$1" "$2"))
    year=${datearray[0]}
    month=${datearray[1]}
    day=${datearray[2]}
    echo $year-$month-$day
}

 syncfile() {
    # date=$(stat -c "%y" "$1" | awk '{printf $1 "\n"}')
    datearray=($(getdatearray "$1" "$3"))
    year=${datearray[0]}
    month=${datearray[1]}
    day=${datearray[2]}
    destdir="$2/$year/$year-$month-$day"
    # echo $destdir
    createdatedir $destdir
    rsync -ptgoDvh "$1" $destdir &>/dev/null
}

convertmovie() {
    if [ ! -f "${1%.*}.mp4" ]; then
        output="${1%.*}.mp4"
        printf "Converting movie $1 to $output"
        ffmpeg -i "$1" -c:v libx264 -preset slow -crf 18 \
            -c:a aac -b:a 128k -r 25 "$output"
        touch -r "$1" "$output"
    fi
}

syncphotos() {
    photodir=/media/photocamera/DCIM
    readarray -t files < <(find "$photodir" -type f -regextype egrep -iregex ".*\.(arw|jpg)")
    numfiles=$(printf '%s\n' "${files[@]}" | wc -l)
    echo "Importing $numfiles photo's...                                      "
    count=1
    for f in ${files[@]}; do
        {
            date=$(printdate "$f")
            # date=$(stat -c "%y" "$f" | awk '{printf $1 "\n"}')
        } 2>/dev/null
        printf "Processing photo $count of $numfiles ($date)                \r"
        notify-send -a import_photos -h int:value:$(echo $count*100/$numfiles | bc) " Photo/Video import" "Importing photo's from photo camera..."
        syncfile "$f" "$importdir"
        count=$((count+1))
    done
}

syncmovies() {
    moviedir=/media/photocamera/PRIVATE/AVCHD
    readarray -t files < <(find "$moviedir" -type f -iname "*.mts")
    numfiles=$(printf '%s\n' "${files[@]}" | wc -l)
    echo "Importing $numfiles video's...                                      "
    count=1
    for f in ${files[@]}; do
        {
            date=$(printdate "$f")
            # date=$(stat -c "%y" "$f" | awk '{printf $1 "\n"}')
        } 2>/dev/null
        printf "Processing movie $count of $numfiles ($date)                \r"
        notify-send -a import_photos -h int:value:$(echo $count*100/$numfiles | bc) " Photo/Video import" "Importing video's from photo camera..."
        syncfile "$f" "$importdir"
        # # date=$(stat -f "%Sm" -t "%Y-%m-%d" "$filename")
        # localfile="$IMPORTDIR/$date/${filename##*/}"
        # [[ "$1" == '--convertmovies' ]] && convertmovie "$localfile"
        count=$((count+1))
    done
}

importcamera() {
    importdir=$HOME/pictures/photocamera
    syncphotos
    syncmovies
    printf "Done!                                                               \n"
    notify-send " Photo/Video import" "All media from photo camera is imported."
}

importiphone() {
    photodir=/media/foonjappie/DCIM
    importdir=$HOME/pictures/foonjappie
    readarray -t files < <(find "$photodir" -type f -regextype egrep -iregex ".*\.(mov|jpg)")
    numfiles=$(printf '%s\n' "${files[@]}" | wc -l)
    echo "Importing $numfiles photo's and video's..."
    count=1
    for f in ${files[@]}; do
        {
            date=$(printdate "$f" "foonjappie")
            # date=$(stat -c "%y" "$f" | awk '{printf $1 "\n"}')
        } 2>/dev/null
        [[ $date == "--" ]] && continue
        printf "Processing file $count of $numfiles ($date)                \r"
        notify-send -a import_photos -h int:value:$(echo $count*100/$numfiles | bc) " Photo/Video import" "Importing media from foonjappie..."

        syncfile "$f" "$importdir" "foonjappie"
        count=$((count+1))
    done
    printf "Done!                                                               \n"
    notify-send -a import_photos " Photo/Video import" "All media from foonjappie is imported."
}

choices=()
choices+=($([ -d /media/foonjappie/DCIM ] && echo "foonjappie"))
choices+=("$([ -d /media/photocamera/DCIM ] && echo 'Photo Camera')")

case "$(printf "%s\n" "${choices[@]}" | dmenu -i -l ${#choices[@]} -p "Import photo's from which device?")" in
    "foonjappie") importiphone ;;
    "Photo Camera") importcamera ;;
esac
