#!/bin/bash

update_monitors() {
    # Replace the 'monitor' in the polybar config with the correct one for the current system.
    activemonitors=($(xrandr --listactivemonitors | awk '!/Monitor/ {print $4}'))
    primary="$(xrandr | awk '{if ($2 == "connected" && $3 == "primary") printf $1}')"
    # The next line assumes there is only 1 extra monitor
    extra="$(xrandr | awk '{if ($2 == "connected" && $3 != "primary") printf $1}')"
    for i in "${activemonitors[@]}"; do
        if [[ $i == $extra ]]; then
            secondary=$extra
            break
        fi
    done

    # Set monitor for topbar
    [[ -n $primary ]] && sed -Ee "s/^(topbar-monitor =).*$/\1 $primary/" -i $HOME/.config/polybar/config

    # Set monitor for topbar-secondary
    [[ -n $secondary ]] && sed -Ee "s/^(topbar-secondary-monitor =).*$/\1 $secondary/" -i $HOME/.config/polybar/config

    # Use ramp-coreload for bigger and ramp-load for smaller monitors
    ramp=$([[ $(xrandr | awk '/primary/ {printf $4}' | cut -d x -f 1) -gt 1920 ]] && echo "ramp-coreload" || echo "ramp-load")
    sed -Ee "s/^(cpu-format =.*)<ramp-[a-z]+>(.*)$/\1<$ramp>\2/" -i $HOME/.config/polybar/config
}

update_modules() {
    # Check modules that are available on the current system
    mpd=$([[ -f $(which mpd 2>/dev/null) ]] && echo mpd)
    mpd_guybrush=$(mpc -h guybrush.local -p 5700 status 2>/dev/null 1>&2 && echo mpd-guybrush)
    wlan=$(nmcli --fields TYPE d | grep -q wifi && echo wlan)
    battery=$([[ -f /sys/class/power_supply/ADP1/online ]] && echo battery)
    alsa=$([[ -f $(which aserver 2>/dev/null) ]] && echo alsa)
    left=" i3 xwindow"
    center=$(echo " pomodoro date $mpd $mpd_guybrush")
    right=$(echo " cpu memory $wlan eth vpn-status $battery temperature $alsa mail")
    sed -E \
        -e "s/^(topbar-modules-left =).*$/\1$left/" \
        -e "s/^(topbar-modules-center =).*$/\1$center/" \
        -e "s/^(topbar-modules-right =).*$/\1$right/" \
        -i $HOME/.config/polybar/config
    secleft=" i3 xwindow"
    seccenter=""
    secright=""
    sed -E \
        -e "s/^(topbar-secondary-modules-left =).*$/\1$secleft/" \
        -e "s/^(topbar-secondary-modules-center =).*$/\1$seccenter/" \
        -e "s/^(topbar-secondary-modules-right =).*$/\1$secright/" \
        -i $HOME/.config/polybar/config
}

update_network() {
    # Find the correct ethernet and wlan devices to use. Only grab the first one.
    wlan=$(nmcli -g DEVICE,TYPE d | awk -F ":" '/wifi/ {print $1}' | head -n 1)
    eth=$(nmcli -g DEVICE,TYPE d | awk -F ":" '/ethernet/ {print $1}' | head -n 1)
    sed -Ee "s/^(wlan =).*$/\1 $wlan/" -e "s/^(eth =).*$/\1 $eth/" -i $HOME/.config/polybar/config
}

# Update the polybar config
[[ -f $HOME/.config/polybar/config.template ]] || exit 1
[[ -f $HOME/.config/polybar/config ]] && rm $HOME/.config/polybar/config
cp $HOME/.config/polybar/config.template $HOME/.config/polybar/config
chmod 600 $HOME/.config/polybar/config
update_monitors
update_modules
update_network

# Terminate already running instances
rm /tmp/ipc-topbar*
killall -q polybar

# Wait until the processes have been shut down
while pgrep -u $UID -x polybar >/dev/null; do sleep 1; done

# Launch new instance
polybar topbar &
ln -s /tmp/polybar_mqueue.$! /tmp/ipc-topbar
if [[ -n $secondary ]]; then
    polybar topbar-secondary &
    ln -s /tmp/polybar_mqueue.$! /tmp/ipc-topbar-secondary
fi

sleep 5
# Restart Dropbox and Protonmail Bridge to ensure their tray icons are
# displayed correctly
[[ $(pgrep -u $UID -f protonmail-bridge) ]] && protonmailbridge_run
[[ $(pgrep -u $UID -x dropbox) ]] && dropbox_run

echo "Bar(s) launched..."
