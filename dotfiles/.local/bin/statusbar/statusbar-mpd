#!/bin/bash

hostinfofile="${XDG_CACHE_HOME:-$HOME/.cache}/mpdhostinfo"

readhostinfo() {
    hostinfo=$(cat "$hostinfofile" 2> /dev/null)
    if [ -n "$hostinfo" ]; then
        host=$(echo "$hostinfo" | cut -d "," -f 1)
        port=$(echo "$hostinfo" | cut -d "," -f 2)
    fi

    # If not found, set to default host 'localhost' and port 6600
    export MPD_HOST="${host:-localhost}"
    export MPD_PORT="${port:-6600}"
}

mpdtoggle() {
    readhostinfo
    mpc toggle &> /dev/null
}

case $BUTTON in
    1) mpdtoggle ;;
    2) readhostinfo && ${TERMINAL} --class OPAQUE -t ncmpcpp-centered \
        -e ncmpcpp -h "${MPD_HOST:-localhost}" -p "${MPD_PORT:-6600}" ;;
    3) mpdswitch ;;
esac

mpd() {
    # icons:    栗

    readhostinfo

    # Limit the amount of characters for the current playing song based on the
    # horizontal resolution
    monitorwidth=$(xdotool getdisplaygeometry | cut -d ' ' -f 1)
    if [[ $monitorwidth -ge 1920 ]]; then
        currentwidth=35
    elif [[ $monitorwidth -ge 1680 ]]; then
        currentwidth=30
    else
        currentwidth=20
    fi

    status=$(mpc status | sed -n 's#^.*\(playing\|paused\|stopped\).*$#\1#p')
    current=$(mpc --format "%artist% - %title%" current \
        | sed "s/^ - //" | sed "s/^\(.\{$currentwidth\}\).*/\1.../")

    case $status in
        "playing") printf "   %s   " "$current" ;;
        "paused") printf "   %s   " "$current" ;;
        *) printf "  栗   " ;;
    esac
}

mpd
